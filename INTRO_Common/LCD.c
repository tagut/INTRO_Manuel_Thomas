/**
 * \file
 * \brief Module to handle the LCD display
 * \author Erich Styger, erich.styger@hslu.ch
 *
 * This module is driving the Nokia LCD Display.
 */

#include "Platform.h"
#if PL_CONFIG_HAS_LCD
#include "LCD.h"
#include "PDC1.h"
#include "GDisp1.h"
#include "GFONT1.h"
#include "FDisp1.h"
#include "Application.h"
#include "UTIL1.h"
#include "LCD_LED.h"
#include "Event.h"
#include "FRTOS1.h"
#include "RApp.h"
#include "LCDMenu.h"

/* status variables */
static bool LedBackLightisOn = TRUE;
static bool requestLCDUpdate = FALSE;

/* this type is declared in PE_Types.h for non-LDD processors, need to declare it locally otherwise */
//typedef struct {                       /* Image */
//  word width;                          /* Image width  */
//  word height;                         /* Image height */
//  const byte * pixmap;                 /* Image pixel bitmap */
//  word size;                           /* Image size   */
//  const char_t * name;                 /* Image name   */
//} TIMAGE;
//typedef TIMAGE* PIMAGE ;               /* Pointer to image */
TIMAGE smily;

byte pixelSmily[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		,0x00,0x00,0x00,0x00,0x03,0xf8,0x00,0x00,0x00,0x00,0x00
		,0x00,0x00,0x00,0x07,0xe0,0x00,0x7e,0x00,0x00,0x00,0x00
		,0x00,0x00,0x00,0x70,0x00,0x00,0x01,0xe0,0x00,0x00,0x00
		,0x00,0x00,0x03,0x80,0x00,0x00,0x00,0x1c,0x00,0x00,0x00
		,0x00,0x00,0x1c,0x00,0x00,0x00,0x00,0x03,0x80,0x00,0x00
		,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00
		,0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00
		,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x00
		,0x00,0x08,0x00,0x03,0xc0,0x00,0x3c,0x00,0x03,0x00,0x00
		,0x00,0x30,0x00,0x0c,0x30,0x00,0xc3,0x00,0x00,0xc0,0x00
		,0x00,0x60,0x00,0x10,0x18,0x01,0x81,0x80,0x00,0x60,0x00
		,0x00,0x80,0x00,0x30,0x0c,0x03,0x00,0xc0,0x00,0x30,0x00
		,0x01,0x00,0x00,0x20,0x0c,0x03,0x00,0x40,0x00,0x18,0x00
		,0x02,0x00,0x00,0x00,0x00,0x02,0x00,0x40,0x00,0x0c,0x00
		,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00
		,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00
		,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00
		,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00
		,0x10,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0xf1,0x80
		,0x10,0xd8,0x7f,0xc0,0x00,0x00,0x00,0x7f,0xe1,0xb0,0x80
		,0x10,0xd0,0x06,0x03,0xff,0xff,0xfe,0x06,0x01,0xb0,0x80
		,0x30,0x50,0x06,0x01,0x80,0x60,0x18,0x06,0x01,0xe0,0xc0
		,0x30,0x78,0x06,0x01,0x80,0x60,0x18,0x06,0x01,0xe0,0xc0
		,0x30,0x7c,0x06,0x01,0x80,0x60,0x18,0x06,0x03,0xe0,0xc0
		,0x30,0x77,0xff,0x01,0x80,0x60,0x18,0x0f,0xff,0xe0,0xc0
		,0x10,0x30,0x01,0xff,0xff,0xff,0xff,0xf8,0x00,0xc0,0x80
		,0x10,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x80
		,0x18,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x81,0x80
		,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x81,0x00
		,0x08,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00
		,0x0c,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x02,0x00
		,0x06,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x06,0x00
		,0x02,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x0c,0x00
		,0x01,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00
		,0x00,0x80,0xe0,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00
		,0x00,0x60,0x7f,0xf8,0x00,0x00,0x03,0xff,0xe0,0x60,0x00
		,0x00,0x30,0x1e,0x0f,0xff,0xff,0xfe,0x07,0x80,0xc0,0x00
		,0x00,0x18,0x0e,0x01,0x80,0x60,0x18,0x07,0x03,0x00,0x00
		,0x00,0x06,0x03,0x81,0x80,0x60,0x18,0x0c,0x06,0x00,0x00
		,0x00,0x01,0x80,0xe1,0x80,0x60,0x18,0x38,0x18,0x00,0x00
		,0x00,0x00,0x60,0x1f,0x80,0x60,0x19,0xc0,0x60,0x00,0x00
		,0x00,0x00,0x1c,0x03,0xc0,0x60,0x1e,0x03,0x80,0x00,0x00
		,0x00,0x00,0x03,0x80,0x1f,0xff,0xc0,0x1c,0x00,0x00,0x00
		,0x00,0x00,0x00,0x78,0x00,0x00,0x01,0xe0,0x00,0x00,0x00
		,0x00,0x00,0x00,0x07,0xe0,0x00,0x7e,0x00,0x00,0x00,0x00
		,0x00,0x00,0x00,0x00,0x03,0xfc,0x00,0x00,0x00,0x00,0x00
		,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

byte pixelMittelfinger[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x03,0xfe,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x0f,0x03,0x80,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x38,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x19,0x06,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1d,0x06,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1d,0xfe,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x78,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x00,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x0c,0x00,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x0c,0x00,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x0c,0xf8,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x0c,0x00,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x0c,0x00,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x00,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x00,0x40,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x00,0x40,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x00,0x40,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x00,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0xf8,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x3e,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x00,0xff,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x1c,0x00,0xff,0xe0,0x00,0x00,0x00
,0x00,0x00,0x00,0x03,0xdc,0x00,0xc1,0xf0,0x00,0x00,0x00
,0x00,0x00,0x18,0x1f,0xfe,0x00,0xc0,0x7e,0x00,0x00,0x00
,0x00,0x01,0xff,0xf8,0x1e,0x00,0xc0,0x3f,0xc0,0x00,0x00
,0x00,0x03,0x81,0xe0,0x0e,0x00,0xc0,0x1f,0xf0,0x00,0x00
,0x00,0x07,0x00,0xe0,0x0e,0x01,0xc0,0x1c,0x7c,0x00,0x00
,0x00,0x06,0x00,0xe0,0x0e,0x01,0xc0,0x1c,0x1e,0x00,0x00
,0x00,0x0e,0x00,0xe0,0x0c,0x01,0xc0,0x1c,0x0e,0x00,0x00
,0x00,0x0c,0x00,0xe0,0x0c,0x01,0xc0,0x1c,0x07,0x00,0x00
,0x00,0x0c,0x00,0xc0,0x1c,0x01,0xc0,0x1f,0x07,0x00,0x00
,0x00,0x1c,0x00,0xc0,0x1c,0x01,0xc0,0x0f,0x07,0x00,0x00
,0x00,0x18,0x00,0xc0,0x1c,0x01,0x80,0x0e,0x07,0x80,0x00
,0x00,0x18,0x00,0xc0,0x1c,0x01,0x80,0x0f,0xc7,0x80,0x00
,0x00,0x18,0x00,0xc0,0x3c,0x01,0x80,0x0f,0xc7,0x80,0x00
,0x00,0x1c,0x00,0xc0,0x1c,0x03,0x80,0x0e,0x07,0x80,0x00
,0x00,0x1c,0x00,0x40,0x0c,0x03,0x80,0x00,0x07,0x80,0x00
,0x00,0x1c,0x00,0x00,0x04,0x01,0x00,0x00,0x07,0x80,0x00
,0x00,0x0e,0x02,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00
,0x00,0x06,0x07,0x00,0x00,0x00,0x00,0x00,0x3e,0x00,0x00
,0x00,0x07,0xff,0x00,0x00,0x00,0x00,0x00,0x70,0x00,0x00
,0x00,0x01,0xff,0x80,0x30,0x00,0x00,0x03,0xe0,0x00,0x00
,0x00,0x00,0x03,0xc0,0x38,0x00,0x3f,0xff,0x00,0x00,0x00
,0x00,0x00,0x00,0xff,0xfc,0x00,0xff,0xe0,0x00,0x00,0x00
,0x00,0x00,0x00,0x0f,0x8f,0x87,0xc0,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x03,0xfe,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};




#if PL_CONFIG_HAS_LCD_MENU
typedef enum {
  LCD_MENU_ID_NONE = LCDMENU_ID_NONE, /* special value! */
  LCD_MENU_ID_MAIN,
    LCD_MENU_ID_BACKLIGHT,
    LCD_MENU_ID_NUM_VALUE,
} LCD_MenuIDs;

static LCDMenu_StatusFlags ValueChangeHandler(const struct LCDMenu_MenuItem_ *item, LCDMenu_EventType event, void **dataP) {
  static int value = 0;
  static uint8_t valueBuf[16];
  LCDMenu_StatusFlags flags = LCDMENU_STATUS_FLAGS_NONE;

  (void)item;
  if (event==LCDMENU_EVENT_GET_TEXT) {
    UTIL1_strcpy(valueBuf, sizeof(valueBuf), (uint8_t*)"Val: ");
    UTIL1_strcatNum32s(valueBuf, sizeof(valueBuf), value);
    *dataP = valueBuf;
    flags |= LCDMENU_STATUS_FLAGS_HANDLED|LCDMENU_STATUS_FLAGS_UPDATE_VIEW;
  } else if (event==LCDMENU_EVENT_GET_EDIT_TEXT) {
    UTIL1_strcpy(valueBuf, sizeof(valueBuf), (uint8_t*)"[-] ");
    UTIL1_strcatNum32s(valueBuf, sizeof(valueBuf), value);
    UTIL1_strcat(valueBuf, sizeof(valueBuf), (uint8_t*)" [+]");
    *dataP = valueBuf;
    flags |= LCDMENU_STATUS_FLAGS_HANDLED|LCDMENU_STATUS_FLAGS_UPDATE_VIEW;
  } else if (event==LCDMENU_EVENT_DECREMENT) {
    value--;
    flags |= LCDMENU_STATUS_FLAGS_HANDLED|LCDMENU_STATUS_FLAGS_UPDATE_VIEW;
  } else if (event==LCDMENU_EVENT_INCREMENT) {
    value++;
    flags |= LCDMENU_STATUS_FLAGS_HANDLED|LCDMENU_STATUS_FLAGS_UPDATE_VIEW;
  }
  return flags;
}

static LCDMenu_StatusFlags BackLightMenuHandler(const struct LCDMenu_MenuItem_ *item, LCDMenu_EventType event, void **dataP) {
  LCDMenu_StatusFlags flags = LCDMENU_STATUS_FLAGS_NONE;

  (void)item;
  if (event==LCDMENU_EVENT_GET_TEXT && dataP!=NULL) {
    if (LedBackLightisOn) {
      *dataP = "Backlight is ON";
    } else {
      *dataP = "Backlight is OFF";
    }
    flags |= LCDMENU_STATUS_FLAGS_HANDLED|LCDMENU_STATUS_FLAGS_UPDATE_VIEW;
  } else if (event==LCDMENU_EVENT_ENTER) { /* toggle setting */
    LedBackLightisOn = !LedBackLightisOn;
    flags |= LCDMENU_STATUS_FLAGS_HANDLED|LCDMENU_STATUS_FLAGS_UPDATE_VIEW;
  }
  return flags;
}

static const LCDMenu_MenuItem menus[] =
{/* id,                                     grp, pos,   up,                       down,                             text,           callback                      flags                  */
    {LCD_MENU_ID_MAIN,                        0,   0,   LCD_MENU_ID_NONE,         LCD_MENU_ID_BACKLIGHT,            "General",      NULL,                         LCDMENU_MENU_FLAGS_NONE},
      {LCD_MENU_ID_BACKLIGHT,                 1,   0,   LCD_MENU_ID_MAIN,         LCD_MENU_ID_NONE,                 NULL,           BackLightMenuHandler,         LCDMENU_MENU_FLAGS_NONE},
      {LCD_MENU_ID_NUM_VALUE,                 1,   1,   LCD_MENU_ID_MAIN,         LCD_MENU_ID_NONE,                 NULL,           ValueChangeHandler,           LCDMENU_MENU_FLAGS_EDITABLE},
};

uint8_t LCD_HandleRemoteRxMessage(RAPP_MSG_Type type, uint8_t size, uint8_t *data, RNWK_ShortAddrType srcAddr, bool *handled, RPHY_PacketDesc *packet) {
  (void)size;
  (void)packet;
  switch(type) {
     default:
      break;
  } /* switch */
  return ERR_OK;
}
#endif /* PL_CONFIG_HAS_LCD_MENU */

void DrawSmily(void) {
	GDisp1_Clear();
    GDisp1_UpdateFull();
	smily.width = 84;
	smily.height = 48;
	smily.size = 4032;
	smily.name = "Smily";
	smily.pixmap = pixelSmily;
	GDisp1_DrawMonoBitmap(0,0,&smily,GDisp1_COLOR_BLACK,GDisp1_COLOR_WHITE);
	GDisp1_UpdateFull();
}

void DrawMittelfinger(void) {
	GDisp1_Clear();
    GDisp1_UpdateFull();
	smily.width = 84;
	smily.height = 48;
	smily.size = 4032;
	smily.name = "Smily";
	smily.pixmap = pixelMittelfinger;
	GDisp1_DrawMonoBitmap(0,0,&smily,GDisp1_COLOR_BLACK,GDisp1_COLOR_WHITE);
	GDisp1_UpdateFull();
}

static void DrawLines(void) {

  int i;
  GDisp1_PixelDim x, y, w, h;

  GDisp1_Clear();
  GDisp1_UpdateFull();

  GDisp1_DrawBox(0, 0, 10, 10, 1, GDisp1_COLOR_BLACK);
  GDisp1_UpdateFull();
  vTaskDelay(pdMS_TO_TICKS(500));

  GDisp1_DrawBox(GDisp1_GetWidth()-10, 0, 10, 10, 1, GDisp1_COLOR_BLACK);
  GDisp1_UpdateFull();
  vTaskDelay(pdMS_TO_TICKS(500));

  GDisp1_DrawLine(0, 0, GDisp1_GetWidth(), GDisp1_GetHeight(), GDisp1_COLOR_BLACK);
  GDisp1_UpdateFull();
  vTaskDelay(pdMS_TO_TICKS(500));
  GDisp1_DrawLine(0, GDisp1_GetHeight(), GDisp1_GetWidth(), 0, GDisp1_COLOR_BLACK);
  GDisp1_UpdateFull();
  vTaskDelay(pdMS_TO_TICKS(500));
  for(i=0;i<10;i++) {
    GDisp1_DrawCircle(GDisp1_GetWidth()/2, GDisp1_GetHeight()/2, 5+i*2, GDisp1_COLOR_BLACK);
    GDisp1_UpdateFull();
    vTaskDelay(pdMS_TO_TICKS(100));
  }
}

static void DrawFont(void) {
  FDisp1_PixelDim x, y;

  GDisp1_Clear();
  GDisp1_UpdateFull();
  x = 0;
  y = 10;
  FDisp1_WriteString("Hello World!", GDisp1_COLOR_BLACK, &x, &y, GFONT1_GetFont());
  GDisp1_UpdateFull();
  vTaskDelay(pdMS_TO_TICKS(500));
  x = 0;
  y += GFONT1_GetBoxHeight();
  FDisp1_WriteString("with Fonts!", GDisp1_COLOR_BLACK, &x, &y, GFONT1_GetFont());
  GDisp1_UpdateFull();
  WAIT1_Waitms(1000);
}

static void DrawText(void) {
  GDisp1_Clear();
  GDisp1_UpdateFull();
  PDC1_WriteLineStr(1, "hello");
  vTaskDelay(pdMS_TO_TICKS(200));
  PDC1_WriteLineStr(2, "world");
  vTaskDelay(pdMS_TO_TICKS(200));
  PDC1_WriteLineStr(3, "out");
  vTaskDelay(pdMS_TO_TICKS(200));
  PDC1_WriteLineStr(4, "there");
  vTaskDelay(pdMS_TO_TICKS(200));
  PDC1_WriteLineStr(5, "!!!!!");
  vTaskDelay(pdMS_TO_TICKS(200));
}

static void ShowTextOnLCD(unsigned char *text) {
  FDisp1_PixelDim x, y;

  GDisp1_Clear();
  x = 0;
  y = 10;
  FDisp1_WriteString(text, GDisp1_COLOR_BLACK, &x, &y, GFONT1_GetFont());
  GDisp1_UpdateFull();
}

static void LCD_Task(void *param) {
  (void)param; /* not used */
#if 1
  ShowTextOnLCD("Press a key!");
  DrawText();
  /* \todo extend */
  DrawFont();
  DrawLines();

  GDisp1_Clear();
  GDisp1_UpdateFull();
  GDisp1_SetPixel(10,10);
  GDisp1_UpdateFull();

  DrawSmily();
  vTaskDelay(pdMS_TO_TICKS(1000));
  DrawMittelfinger();
  //DrawCircles(); MANUEL
#endif
#if PL_CONFIG_HAS_LCD_MENU
  LCDMenu_InitMenu(menus, sizeof(menus)/sizeof(menus[0]), 1);
  LCDMenu_OnEvent(LCDMENU_EVENT_DRAW, NULL);
#endif
  for(;;) {
    if (LedBackLightisOn) {
      LCD_LED_On(); /* LCD backlight on */
    } else {
      LCD_LED_Off(); /* LCD backlight off */
    }
#if PL_CONFIG_HAS_LCD_MENU
    if (requestLCDUpdate) {
      requestLCDUpdate = FALSE;
      LCDMenu_OnEvent(LCDMENU_EVENT_DRAW, NULL);
    }
#if 1 /*! \todo Change this to for your own needs, or use direct task notification */
    if (EVNT_EventIsSetAutoClear(EVNT_SW2_PRESSED)) { /* left *///EVNT_LCD_BTN_LEFT
      LCDMenu_OnEvent(LCDMENU_EVENT_LEFT, NULL);
//      ShowTextOnLCD("left");
    }
    if (EVNT_EventIsSetAutoClear(EVNT_SW1_PRESSED)) { /* right */ //EVNT_LCD_BTN_RIGHT
      LCDMenu_OnEvent(LCDMENU_EVENT_RIGHT, NULL);
//      ShowTextOnLCD("right");
    }
    if (EVNT_EventIsSetAutoClear(EVNT_SW5_PRESSED)) { /* up */  //EVNT_LCD_BTN_UP
      LCDMenu_OnEvent(LCDMENU_EVENT_UP, NULL);
//      ShowTextOnLCD("up");
    }
    if (EVNT_EventIsSetAutoClear(EVNT_SW3_PRESSED)) { /* down */  //EVNT_LCD_BTN_DOWN
      LCDMenu_OnEvent(LCDMENU_EVENT_DOWN, NULL);
//      ShowTextOnLCD("down");
    }
    if (EVNT_EventIsSetAutoClear(EVNT_SW4_PRESSED)) { /* center */ //EVNT_LCD_BTN_CENTER
      LCDMenu_OnEvent(LCDMENU_EVENT_ENTER, NULL);
//      ShowTextOnLCD("center");
    }
    if (EVNT_EventIsSetAutoClear(EVNT_SW7_PRESSED)) { /* side up */ //EVNT_LCD_SIDE_BTN_UP
      LCDMenu_OnEvent(LCDMENU_EVENT_UP, NULL);
//      ShowTextOnLCD("side up");
    }
    if (EVNT_EventIsSetAutoClear(EVNT_SW6_PRESSED)) { /* side down */ //EVNT_LCD_SIDE_BTN_DOWN
      LCDMenu_OnEvent(LCDMENU_EVENT_DOWN, NULL);
//      ShowTextOnLCD("side down");
    }
#endif
#endif /* PL_CONFIG_HAS_LCD_MENU */
    vTaskDelay(pdMS_TO_TICKS(20));
  }
}

void LCD_Deinit(void) {
#if PL_CONFIG_HAS_LCD_MENU
  LCDMenu_Deinit();
#endif
}

void LCD_Init(void) {
  LedBackLightisOn =  TRUE;
  if (xTaskCreate(LCD_Task, "LCD", configMINIMAL_STACK_SIZE+30, NULL, tskIDLE_PRIORITY, NULL) != pdPASS) {//&LCDTaskHandle) != pdPASS) {
    for(;;){} /* error! probably out of memory */
  }
#if PL_CONFIG_HAS_LCD_MENU
  LCDMenu_Init();
#endif
}
#endif /* PL_CONFIG_HAS_LCD */
